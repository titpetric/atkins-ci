---
version: "3"

tasks:
  default:
    cmds:
      - task: install
      - task: test

  install:
    cmds:
      - task: fmt
      - go install -trimpath .

  fmt:
    silent: true
    cmds:
      - goimports -w .
      - go mod tidy
      - go fmt ./...

  test:
    cmds:
      - gotestsum ./... -- -count 1
      - task: test:fixtures

  record:
    cmds:
      - task: install
      - rm -rf examples ; mkdir -p examples
      - task: record:fixtures

  record:fixtures:
    cmds:
      - asciinema rec --cols 80 --rows 25 -t "Atkins detach example" -c "atkins -file tests/detach.yml" examples/detach.yml.cast
      - $HOME/.cargo/bin/agg examples/detach.yml.cast examples/detach.yml.gif
      - asciinema rec --cols 80 --rows 25 -t "Atkins depends_on example" -c "atkins -file tests/depends_on.yml" examples/depends_on.yml.cast
      - $HOME/.cargo/bin/agg examples/depends_on.yml.cast examples/depends_on.yml.gif
      - asciinema rec --cols 80 --rows 25 -t "Atkins root_jobs example" -c "atkins -file tests/root_jobs.yml" examples/root_jobs.yml.cast
      - $HOME/.cargo/bin/agg examples/root_jobs.yml.cast examples/root_jobs.yml.gif
      - asciinema rec --cols 80 --rows 25 -t "Atkins nested example" -c "atkins -file tests/nested.yml" examples/nested.yml.cast
      - $HOME/.cargo/bin/agg examples/nested.yml.cast examples/nested.yml.gif

  record:gif:
    cmds:
      - $HOME/.cargo/bin/agg atkins.cast atkins.gif

  run:
    cmds:
      - task: install
      - atkins -file test/pipelines/atkins.yml

  run:error:
    cmds:
      - task: install
      - atkins -file test/pipelines/atkins-err.yml

  test:fixtures:
    cmds:
      - atkins -file tests/detach.yml
      - atkins -file tests/depends_on.yml
      - atkins -file tests/root_jobs.yml
      - atkins -file tests/nested.yml
